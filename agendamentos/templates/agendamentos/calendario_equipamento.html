{% extends 'base.html' %}
{% load static %}

{% block conteudo %}
  <div class="container">
    <h1>{{ equipamento.nome }}</h1>

    <div>
      {% for mes in meses %}
        <h2>Mês: {{ mes.nome }} Ano: {{ mes.ano }}</h2>
        <table>
          <thead>
            <tr class="">
              <th></th>
              <th>8:00</th>
              <th>8:30</th>
              <th>9:00</th>
              <th>9:30</th>
              <th>10:00</th>
              <th>10:30</th>
              <th>11:00</th>
              <th>11:30</th>
              <th>12:00</th>
              <th>12:30</th>
              <th>13:00</th>
              <th>13:30</th>
              <th>14:00</th>
              <th>14:30</th>
              <th>15:00</th>
              <th>15:30</th>
              <th>16:00</th>
              <th>16:30</th>
              <th>17:00</th>
              <th>17:30</th>
              <th>18:00</th>
              <th>18:30</th>
              <th>19:00</th>
              <th>19:30</th>
              <th>20:00</th>
              <th>20:30</th>
              <th>21:00</th>
              <th>21:30</th>
              <th>22:00</th>
            </tr>
          </thead>
          <tbody>
            {% for dia in mes.dia_set.all|dictsort:'numero' %}
              <tr>
                {% if dia.feriado %}
                  <td class="text-danger">{{ dia.numero }}</td>
                {% elif dia.dia_da_semana == 'segunda' or dia.dia_da_semana == 'terca' or dia.dia_da_semana == 'quarta' or dia.dia_da_semana == 'quinta' or dia.dia_da_semana == 'sexta' %}
                  <td class="text-success">{{ dia.numero }}</td>
                {% else %}
                  <td class="text-danger">{{ dia.numero }}</td>
                {% endif %}

                {% for hora in horarios %}
                  {% if dia.feriado %}
                    <td>X</td>
                  {% elif dia.dia_da_semana == 'segunda' or dia.dia_da_semana == 'terca' or dia.dia_da_semana == 'quarta' or dia.dia_da_semana == 'quinta' or dia.dia_da_semana == 'sexta' %}
                    <td>
                      <button class="btn-agendamento" onclick="openPopup('{{ dia.numero }}', '{{ hora }}', '{{ user.email }}')"></button>
                    </td>
                  {% else %}
                    <td>X</td>
                  {% endif %}
                {% endfor %}
              </tr>
            {% endfor %}
          </tbody>
        </table>
      {% endfor %}
    </div>
  </div>

  <!-- Modifique o pop-up para incluir um formulário -->
  <div id="reservationPopup" class="popup">
    <p id="emailParagraph"></p>
    <form action="{% url 'realizar_agendamento' %}" method="post" id="reservationForm" class="reservationForm">
      {% csrf_token %}
      <div class="mb-3 d-flex justify-content-around">
        <label for="dataInput">Data:</label>
        <input type="date" name="data" id="dataInput" value="" readonly required />
        <input type="hidden" name="dataHidden" id="dataHidden" value="" />
      </div>
      <div class="mb-3 d-flex justify-content-around">
        <label for="horarioInicio">Horário Início:</label>
        <input type="text" name="horarioInicio" id="horarioInicio" value="" readonly required />
        <input type="hidden" name="horaInicioHidden" id="horaInicioHidden" value="" />
      </div>
      <div class="mb-3 d-flex justify-content-around">
        <label for="horarioTermino">Horário Término:</label>
        <input type="text" name="horarioTermino" id="horarioTermino" required />
      </div>

      <p>Digite alguma informação nescessária:</p>
      <textarea name="informacao_adicional" class="popup-agendamento" id="" required></textarea>

      <button type="submit" class="btn-agendar">Reservar</button>
    </form>
    <button class="btn btn-danger" onclick="closePopup()">Fechar</button>
  </div>

  <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

  <script>
    // Função para converter nome do mês para formato de dois dígitos
    function mesParaNumero(mes) {
      var meses = {
          janeiro: '01',
          fevereiro: '02',
          março: '03',
          abril: '04',
          maio: '05',
          junho: '06',
          julho: '07',
          agosto: '08',
          setembro: '09',
          outubro: '10',
          novembro: '11',
          dezembro: '12'
      }

      // Remove caracteres especiais e converte para minúsculas
      var mesFormatado = mes.replace(/[^\w\s]/gi, '').toLowerCase();

      return meses[mesFormatado] || mes;
  }

  // Função para formatar a data como "YYYY-MM-DD"
  function formatarData(dia, mes, ano) {
      // Adicione zeros à esquerda se necessário
      mes = mes.padStart(2, '0');
      dia = dia.padStart(2, '0');

      return ano + '-' + mes + '-' + dia;
  }

  // ...

  // Função para abrir o popup
  function openPopup(dia, hora, email) {
      // Obtenha o mês e o ano do título
      var mesAno = $('h2:contains("Mês:")').text().split('Ano: ');
      var mes = mesAno[0].replace('Mês: ', '').trim();
      var ano = mesAno[1].trim();

      // Converta o nome do mês para o formato de dois dígitos
      var mesNumerico = mesParaNumero(mes);

      // Formate a data como "YYYY-MM-DD"
      var dataFormatada = formatarData(dia, mesNumerico, ano);

      // Preencha os campos do formulário
      $('#dataInput').val(dataFormatada);
      $('#dataHidden').val(dataFormatada); // Use um campo oculto para enviar a data no formulário
      $('#emailParagraph').text('Email: ' + email);
      $('#horarioInicio').val(hora);

      // Exiba o pop-up
      $('#reservationPopup').show();
  }

  </script>
{% endblock %}
